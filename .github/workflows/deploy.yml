name: Deploy SecureAuditAI Agent

permissions:
  id-token: write   # This is required for requesting the JWT
  contents: read    # This is required for actions/checkout

on:
  # push:
  #   branches: [ main ]
  #   paths-ignore:
  #     - '**.md'
  #     - '.gitignore'
  #     - 'LICENSE'
  #     - 'assets/**'
  # pull_request:
  #   branches: [ main ]
  #   paths-ignore:
  #     - '**.md'
  #     - '.gitignore'
  #     - 'LICENSE'
  #     - 'assets/**'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - prod

env:
  AWS_REGION: us-west-2
  AWS_DEFAULT_REGION: us-west-2
  PYTHON_VERSION: '3.11'
  NODE_VERSION: '18'

jobs:
  # CloudFormation Validation
  validate-infrastructure:
    name: Validate Infrastructure
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' || github.event_name == 'workflow_dispatch'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials via OIDC
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::${{ secrets.AWS_ACCOUNT_ID }}:role/personal-github-oidc-role
          aws-region: ${{ env.AWS_REGION }}

      - name: Package Lambda functions
        run: |
          # Create deployment packages for Lambda functions
          mkdir -p lambda-packages

          # Package trigger_scan.py
          cd lambda
          zip -r ../lambda-packages/trigger_scan.zip trigger_scan.py
          cd ..

          # Package api_audit_runs.py
          cd lambda
          zip -r ../lambda-packages/api_audit_runs.zip api_audit_runs.py
          cd ..

          # Package api_findings.py
          cd lambda
          zip -r ../lambda-packages/api_findings.zip api_findings.py
          cd ..

          # Upload packages to S3
          ENVIRONMENT="${{ github.event.inputs.environment || 'dev' }}"
          STACK_NAME="secureauditai-agent-${ENVIRONMENT}"
          LAMBDA_BUCKET="${STACK_NAME}-lambda-code-${ENVIRONMENT}"

          # Ensure bucket exists in the correct region
          if aws s3api head-bucket --bucket "${LAMBDA_BUCKET}" --region ${{ env.AWS_REGION }} 2>/dev/null; then
            echo "âœ… Bucket ${LAMBDA_BUCKET} exists in region ${{ env.AWS_REGION }}"
          else
            echo "ðŸ“¦ Creating bucket ${LAMBDA_BUCKET} in region ${{ env.AWS_REGION }}"
            aws s3 mb "s3://${LAMBDA_BUCKET}" --region ${{ env.AWS_REGION }}
          fi

          # Upload packages
          aws s3 cp lambda-packages/trigger_scan.zip "s3://${LAMBDA_BUCKET}/lambda/trigger_scan.zip" --region ${{ env.AWS_REGION }}
          aws s3 cp lambda-packages/api_audit_runs.zip "s3://${LAMBDA_BUCKET}/lambda/api_audit_runs.zip" --region ${{ env.AWS_REGION }}
          aws s3 cp lambda-packages/api_findings.zip "s3://${LAMBDA_BUCKET}/lambda/api_findings.zip" --region ${{ env.AWS_REGION }}

      - name: Validate CloudFormation template
        run: |
          aws cloudformation validate-template \
            --template-body file://cloudformation/template.yaml

      - name: Validate CloudFormation IAM requirements
        run: |
          # Check if CloudFormation template contains IAM resources that require capabilities
          if grep -q "AWS::IAM::Role\|AWS::IAM::Policy\|AWS::IAM::ManagedPolicy" cloudformation/template.yaml; then
            echo "âœ… Template contains IAM resources - CAPABILITY_NAMED_IAM required"
          else
            echo "â„¹ï¸ Template does not contain IAM resources"
          fi

  # Deploy to Development
  deploy-dev:
    name: Deploy to Development
    runs-on: ubuntu-latest
    needs: validate-infrastructure
    if: (github.ref == 'refs/heads/main' && github.event_name == 'push') || (github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'dev')
    environment: dev
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials via OIDC
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::${{ secrets.AWS_ACCOUNT_ID }}:role/personal-github-oidc-role
          aws-region: ${{ env.AWS_REGION }}

      - name: Generate deterministic Cognito domain prefix
        id: generate-domain
        run: |
          # Generate deterministic Cognito domain prefix
          echo "ðŸ”„ Generating deterministic Cognito domain prefix..."
          ENVIRONMENT="${{ github.event.inputs.environment || 'dev' }}"
          ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)

          # Create deterministic suffix based on account ID (last 8 digits)
          DETERMINISTIC_SUFFIX="${ACCOUNT_ID: -8}"
          # Ensure suffix contains only valid characters
          DETERMINISTIC_SUFFIX=$(echo "$DETERMINISTIC_SUFFIX" | tr -cd 'a-z0-9')
          COGNITO_PREFIX="secureauditai-${ENVIRONMENT}-${DETERMINISTIC_SUFFIX}"

          # Validate domain format (must be lowercase alphanumeric with hyphens, 1-63 chars)
          if [[ ! "$COGNITO_PREFIX" =~ ^[a-z0-9]([a-z0-9-]*[a-z0-9])?$ ]] || [[ ${#COGNITO_PREFIX} -lt 1 ]] || [[ ${#COGNITO_PREFIX} -gt 63 ]]; then
            echo "âŒ Invalid domain format: $COGNITO_PREFIX"
            exit 1
          fi

          echo "âœ… Generated domain: ${COGNITO_PREFIX}"
          echo "ðŸ“ Domain is deterministic based on account ID"
          echo "ðŸ” Domain length: ${#COGNITO_PREFIX} characters"

          echo "COGNITO_DOMAIN=${COGNITO_PREFIX}" >> $GITHUB_OUTPUT

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install deployment dependencies
        run: |
          python -m pip install --upgrade pip
          pip install boto3

      - name: Deploy CloudFormation stack
        run: |
          ENVIRONMENT="${{ github.event.inputs.environment || 'dev' }}"
          STACK_NAME="secureauditai-agent-${ENVIRONMENT}"
          LAMBDA_BUCKET="${STACK_NAME}-lambda-code-${ENVIRONMENT}"
          BEDROCK_MODEL_ID="${{ secrets.BEDROCK_MODEL_ID || 'anthropic.claude-3-5-sonnet-20241022-v2:0' }}"

          # Generate unique Cognito domain prefix
          COGNITO_DOMAIN="${{ steps.generate-domain.outputs.COGNITO_DOMAIN }}"

          # Deploy or update CloudFormation stack
          if aws cloudformation describe-stacks --stack-name "$STACK_NAME" --region ${{ env.AWS_REGION }} &> /dev/null; then
            echo "Updating existing stack..."
            aws cloudformation update-stack \
              --stack-name "$STACK_NAME" \
              --template-body file://cloudformation/template.yaml \
              --parameters \
                ParameterKey=Environment,ParameterValue="$ENVIRONMENT" \
                ParameterKey=BedrockModelId,ParameterValue="$BEDROCK_MODEL_ID" \
                ParameterKey=LambdaCodeBucketName,ParameterValue="$LAMBDA_BUCKET" \
              --capabilities CAPABILITY_NAMED_IAM \
              --region ${{ env.AWS_REGION }}

            aws cloudformation wait stack-update-complete \
              --stack-name "$STACK_NAME" \
              --region ${{ env.AWS_REGION }}
          else
            echo "Creating new stack..."
            aws cloudformation create-stack \
              --stack-name "$STACK_NAME" \
              --template-body file://cloudformation/template.yaml \
              --parameters \
                ParameterKey=Environment,ParameterValue="$ENVIRONMENT" \
                ParameterKey=BedrockModelId,ParameterValue="$BEDROCK_MODEL_ID" \
                ParameterKey=LambdaCodeBucketName,ParameterValue="$LAMBDA_BUCKET" \
              --capabilities CAPABILITY_NAMED_IAM \
              --region ${{ env.AWS_REGION }}

            aws cloudformation wait stack-create-complete \
              --stack-name "$STACK_NAME" \
              --region ${{ env.AWS_REGION }}
          fi

          echo "âœ… CloudFormation stack deployed successfully"

      - name: Create or verify Cognito domain
        run: |
          ENVIRONMENT="${{ github.event.inputs.environment || 'dev' }}"
          STACK_NAME="secureauditai-agent-${ENVIRONMENT}"
          COGNITO_DOMAIN="${{ steps.generate-domain.outputs.COGNITO_DOMAIN }}"

          # Get User Pool ID from CloudFormation outputs
          USER_POOL_ID=$(aws cloudformation describe-stacks \
            --stack-name "$STACK_NAME" \
            --region ${{ env.AWS_REGION }} \
            --query 'Stacks[0].Outputs[?OutputKey==`UserPoolId`].OutputValue' \
            --output text)

          if [ "$USER_POOL_ID" = "None" ] || [ -z "$USER_POOL_ID" ]; then
            echo "âŒ Failed to get User Pool ID from stack outputs"
            exit 1
          fi

          # Check if domain already exists
          if aws cognito-idp describe-user-pool-domain --domain "$COGNITO_DOMAIN" --region ${{ env.AWS_REGION }} >/dev/null 2>&1; then
            echo "âœ… Domain $COGNITO_DOMAIN already exists - verifying association"

            # Verify the domain is associated with our user pool
            DOMAIN_POOL_ID=$(aws cognito-idp describe-user-pool-domain \
              --domain "$COGNITO_DOMAIN" \
              --region ${{ env.AWS_REGION }} \
              --query 'DomainDescription.UserPoolId' \
              --output text)

            if [ "$DOMAIN_POOL_ID" = "$USER_POOL_ID" ]; then
              echo "âœ… Domain $COGNITO_DOMAIN is correctly associated with User Pool $USER_POOL_ID"
            else
              echo "âš ï¸ Domain $COGNITO_DOMAIN exists but is associated with different User Pool: $DOMAIN_POOL_ID"
              echo "This may cause issues. Consider using a different domain name."
            fi
          else
            echo "ðŸ“ Creating new domain: $COGNITO_DOMAIN"
            aws cognito-idp create-user-pool-domain \
              --domain "$COGNITO_DOMAIN" \
              --user-pool-id "$USER_POOL_ID" \
              --region ${{ env.AWS_REGION }}

            echo "âœ… Domain $COGNITO_DOMAIN created successfully"
          fi

      - name: Deploy React frontend
        run: |
          ENVIRONMENT="${{ github.event.inputs.environment || 'dev' }}"
          STACK_NAME="secureauditai-agent-${ENVIRONMENT}"

          # Install frontend dependencies
          cd frontend
          npm ci

          # Configure Amplify with CloudFormation outputs
          cd ..
          USER_POOL_ID=$(aws cloudformation describe-stacks --stack-name "$STACK_NAME" --region ${{ env.AWS_REGION }} --query 'Stacks[0].Outputs[?OutputKey==`UserPoolId`].OutputValue' --output text)
          USER_POOL_CLIENT_ID=$(aws cloudformation describe-stacks --stack-name "$STACK_NAME" --region ${{ env.AWS_REGION }} --query 'Stacks[0].Outputs[?OutputKey==`UserPoolClientId`].OutputValue' --output text)
          node scripts/configure-frontend.js "$USER_POOL_ID" "$USER_POOL_CLIENT_ID" "${{ env.AWS_REGION }}"

          # Build for production
          cd frontend
          npm run build

          # Get frontend bucket name from stack outputs
          FRONTEND_BUCKET=$(aws cloudformation describe-stacks \
            --stack-name "$STACK_NAME" \
            --region ${{ env.AWS_REGION }} \
            --query 'Stacks[0].Outputs[?OutputKey==`FrontendBucketName`].OutputValue' \
            --output text)

          if [ "$FRONTEND_BUCKET" != "None" ]; then
            echo "Deploying frontend to S3 bucket: $FRONTEND_BUCKET"

            # Sync build to S3 with cache control
            aws s3 sync build/ s3://"$FRONTEND_BUCKET" \
              --delete \
              --cache-control max-age=31536000 \
              --region ${{ env.AWS_REGION }}

            # Enable static website hosting
            aws s3 website s3://"$FRONTEND_BUCKET" \
              --index-document index.html \
              --error-document index.html \
              --region ${{ env.AWS_REGION }}

            FRONTEND_URL="http://${FRONTEND_BUCKET}.s3-website-${{ env.AWS_REGION }}.amazonaws.com"
            echo "âœ… Frontend deployed to: $FRONTEND_URL"
            echo "frontend_url=$FRONTEND_URL" >> $GITHUB_OUTPUT
          else
            echo "âŒ Frontend bucket not found in stack outputs"
            exit 1
          fi

      - name: Build and deploy AgentCore runtime
        if: success()
        run: |
          ENVIRONMENT="${{ github.event.inputs.environment || 'dev' }}"
          STACK_NAME="secureauditai-agent-${ENVIRONMENT}"

          # Install Python dependencies for AgentCore
          python -m pip install --upgrade pip
          pip install -r agent/requirements.txt

          # Get ECR repository URI from stack outputs
          ECR_REPO=$(aws cloudformation describe-stacks \
            --stack-name "$STACK_NAME" \
            --region ${{ env.AWS_REGION }} \
            --query 'Stacks[0].Outputs[?OutputKey==`EcrRepositoryUri`].OutputValue' \
            --output text 2>/dev/null || echo "")

          if [ -n "$ECR_REPO" ] && [ "$ECR_REPO" != "None" ]; then
            echo "Building and pushing AgentCore runtime to ECR: $ECR_REPO"

            # Build Docker image
            docker build -t secureauditai-agent agent/

            # Tag and push to ECR
            REPO_NAME=$(echo "$ECR_REPO" | cut -d'/' -f2)
            aws ecr get-login-password --region ${{ env.AWS_REGION }} | docker login --username AWS --password-stdin "$ECR_REPO"
            docker tag secureauditai-agent:latest "$ECR_REPO":latest
            docker push "$ECR_REPO":latest

            echo "âœ… AgentCore runtime deployed to ECR"
          else
            echo "âš ï¸ ECR repository not found in stack outputs. Skipping AgentCore deployment."
          fi

      - name: Extract deployment outputs
        id: deployment
        run: |
          API_GATEWAY_URL=$(aws cloudformation describe-stacks \
            --stack-name secureauditai-agent-dev \
            --region ${{ env.AWS_REGION }} \
            --query 'Stacks[0].Outputs[?OutputKey==`ApiGatewayUrl`].OutputValue' \
            --output text)
          USER_POOL_ID=$(aws cloudformation describe-stacks \
            --stack-name secureauditai-agent-dev \
            --region ${{ env.AWS_REGION }} \
            --query 'Stacks[0].Outputs[?OutputKey==`UserPoolId`].OutputValue' \
            --output text)
          FRONTEND_BUCKET=$(aws cloudformation describe-stacks \
            --stack-name secureauditai-agent-dev \
            --region ${{ env.AWS_REGION }} \
            --query 'Stacks[0].Outputs[?OutputKey==`FrontendBucketName`].OutputValue' \
            --output text)

          echo "api_gateway_url=$API_GATEWAY_URL" >> $GITHUB_OUTPUT
          echo "user_pool_id=$USER_POOL_ID" >> $GITHUB_OUTPUT
          echo "frontend_bucket=$FRONTEND_BUCKET" >> $GITHUB_OUTPUT

      - name: Create demo user
        run: |
          aws cognito-idp admin-create-user \
            --user-pool-id ${{ steps.deployment.outputs.user_pool_id }} \
            --username demo@secureauditai.com \
            --temporary-password TempPass123! \
            --message-action SUPPRESS \
            --region ${{ env.AWS_REGION }}

      - name: Comment PR with deployment info
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v6
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `ðŸš€ **Development deployment completed!**

              **API Gateway:** ${{ steps.deployment.outputs.api_gateway_url }}
              **Frontend:** http://${{ steps.deployment.outputs.frontend_bucket }}.s3-website-${{ env.AWS_REGION }}.amazonaws.com

              **Demo Credentials:**
              - Email: demo@secureauditai.com
              - Password: TempPass123!

              Ready for testing! ðŸŽ‰`
            })

  # Deploy to Production (Manual with Approval)
  deploy-prod:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: deploy-dev
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'prod'
    environment: prod
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials via OIDC
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::${{ secrets.AWS_ACCOUNT_ID }}:role/personal-github-oidc-role
          aws-region: ${{ env.AWS_REGION }}

      - name: Generate deterministic Cognito domain prefix
        id: generate-domain-prod
        run: |
          # Generate deterministic Cognito domain prefix
          echo "ðŸ”„ Generating deterministic Cognito domain prefix..."
          ENVIRONMENT="${{ github.event.inputs.environment || 'prod' }}"
          ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)

          # Create deterministic suffix based on account ID (last 8 digits)
          DETERMINISTIC_SUFFIX="${ACCOUNT_ID: -8}"
          # Ensure suffix contains only valid characters
          DETERMINISTIC_SUFFIX=$(echo "$DETERMINISTIC_SUFFIX" | tr -cd 'a-z0-9')
          COGNITO_PREFIX="secureauditai-${ENVIRONMENT}-${DETERMINISTIC_SUFFIX}"

          # Validate domain format (must be lowercase alphanumeric with hyphens, 1-63 chars)
          if [[ ! "$COGNITO_PREFIX" =~ ^[a-z0-9]([a-z0-9-]*[a-z0-9])?$ ]] || [[ ${#COGNITO_PREFIX} -lt 1 ]] || [[ ${#COGNITO_PREFIX} -gt 63 ]]; then
            echo "âŒ Invalid domain format: $COGNITO_PREFIX"
            exit 1
          fi

          echo "âœ… Generated domain: ${COGNITO_PREFIX}"
          echo "ðŸ“ Domain is deterministic based on account ID"
          echo "ðŸ” Domain length: ${#COGNITO_PREFIX} characters"

          echo "COGNITO_DOMAIN=${COGNITO_PREFIX}" >> $GITHUB_OUTPUT

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install deployment dependencies
        run: |
          python -m pip install --upgrade pip
          pip install boto3

      - name: Deploy CloudFormation stack
        run: |
          ENVIRONMENT="${{ github.event.inputs.environment || 'prod' }}"
          STACK_NAME="secureauditai-agent-${ENVIRONMENT}"
          LAMBDA_BUCKET="${STACK_NAME}-lambda-code-${ENVIRONMENT}"
          BEDROCK_MODEL_ID="${{ secrets.BEDROCK_MODEL_ID || 'anthropic.claude-3-5-sonnet-20241022-v2:0' }}"

          # Deploy or update CloudFormation stack
          if aws cloudformation describe-stacks --stack-name "$STACK_NAME" --region ${{ env.AWS_REGION }} &> /dev/null; then
            echo "Updating existing stack..."
            aws cloudformation update-stack \
              --stack-name "$STACK_NAME" \
              --template-body file://cloudformation/template.yaml \
              --parameters \
                ParameterKey=Environment,ParameterValue="$ENVIRONMENT" \
                ParameterKey=BedrockModelId,ParameterValue="$BEDROCK_MODEL_ID" \
                ParameterKey=LambdaCodeBucketName,ParameterValue="$LAMBDA_BUCKET" \
              --capabilities CAPABILITY_NAMED_IAM \
              --region ${{ env.AWS_REGION }}

            aws cloudformation wait stack-update-complete \
              --stack-name "$STACK_NAME" \
              --region ${{ env.AWS_REGION }}
          else
            echo "Creating new stack..."
            aws cloudformation create-stack \
              --stack-name "$STACK_NAME" \
              --template-body file://cloudformation/template.yaml \
              --parameters \
                ParameterKey=Environment,ParameterValue="$ENVIRONMENT" \
                ParameterKey=BedrockModelId,ParameterValue="$BEDROCK_MODEL_ID" \
                ParameterKey=LambdaCodeBucketName,ParameterValue="$LAMBDA_BUCKET" \
              --capabilities CAPABILITY_NAMED_IAM \
              --region ${{ env.AWS_REGION }}

            aws cloudformation wait stack-create-complete \
              --stack-name "$STACK_NAME" \
              --region ${{ env.AWS_REGION }}
          fi

          echo "âœ… CloudFormation stack deployed successfully"

      - name: Create or verify Cognito domain
        run: |
          ENVIRONMENT="${{ github.event.inputs.environment || 'prod' }}"
          STACK_NAME="secureauditai-agent-${ENVIRONMENT}"
          COGNITO_DOMAIN="${{ steps.generate-domain-prod.outputs.COGNITO_DOMAIN }}"

          # Get User Pool ID from CloudFormation outputs
          USER_POOL_ID=$(aws cloudformation describe-stacks \
            --stack-name "$STACK_NAME" \
            --region ${{ env.AWS_REGION }} \
            --query 'Stacks[0].Outputs[?OutputKey==`UserPoolId`].OutputValue' \
            --output text)

          if [ "$USER_POOL_ID" = "None" ] || [ -z "$USER_POOL_ID" ]; then
            echo "âŒ Failed to get User Pool ID from stack outputs"
            exit 1
          fi

          # Check if domain already exists
          if aws cognito-idp describe-user-pool-domain --domain "$COGNITO_DOMAIN" --region ${{ env.AWS_REGION }} >/dev/null 2>&1; then
            echo "âœ… Domain $COGNITO_DOMAIN already exists - verifying association"

            # Verify the domain is associated with our user pool
            DOMAIN_POOL_ID=$(aws cognito-idp describe-user-pool-domain \
              --domain "$COGNITO_DOMAIN" \
              --region ${{ env.AWS_REGION }} \
              --query 'DomainDescription.UserPoolId' \
              --output text)

            if [ "$DOMAIN_POOL_ID" = "$USER_POOL_ID" ]; then
              echo "âœ… Domain $COGNITO_DOMAIN is correctly associated with User Pool $USER_POOL_ID"
            else
              echo "âš ï¸ Domain $COGNITO_DOMAIN exists but is associated with different User Pool: $DOMAIN_POOL_ID"
              echo "This may cause issues. Consider using a different domain name."
            fi
          else
            echo "ðŸ“ Creating new domain: $COGNITO_DOMAIN"
            aws cognito-idp create-user-pool-domain \
              --domain "$COGNITO_DOMAIN" \
              --user-pool-id "$USER_POOL_ID" \
              --region ${{ env.AWS_REGION }}

            echo "âœ… Domain $COGNITO_DOMAIN created successfully"
          fi

      - name: Deploy React frontend
        run: |
          ENVIRONMENT="${{ github.event.inputs.environment || 'prod' }}"
          STACK_NAME="secureauditai-agent-${ENVIRONMENT}"

          # Install frontend dependencies
          cd frontend
          npm ci

          # Configure Amplify with CloudFormation outputs
          cd ..
          USER_POOL_ID=$(aws cloudformation describe-stacks --stack-name "$STACK_NAME" --region ${{ env.AWS_REGION }} --query 'Stacks[0].Outputs[?OutputKey==`UserPoolId`].OutputValue' --output text)
          USER_POOL_CLIENT_ID=$(aws cloudformation describe-stacks --stack-name "$STACK_NAME" --region ${{ env.AWS_REGION }} --query 'Stacks[0].Outputs[?OutputKey==`UserPoolClientId`].OutputValue' --output text)
          node scripts/configure-frontend.js "$USER_POOL_ID" "$USER_POOL_CLIENT_ID" "${{ env.AWS_REGION }}"

          # Build for production
          cd frontend
          npm run build

          # Get frontend bucket name from stack outputs
          FRONTEND_BUCKET=$(aws cloudformation describe-stacks \
            --stack-name "$STACK_NAME" \
            --region ${{ env.AWS_REGION }} \
            --query 'Stacks[0].Outputs[?OutputKey==`FrontendBucketName`].OutputValue' \
            --output text)

          if [ "$FRONTEND_BUCKET" != "None" ]; then
            echo "Deploying frontend to S3 bucket: $FRONTEND_BUCKET"

            # Sync build to S3 with cache control
            aws s3 sync build/ s3://"$FRONTEND_BUCKET" \
              --delete \
              --cache-control max-age=31536000 \
              --region ${{ env.AWS_REGION }}

            # Enable static website hosting
            aws s3 website s3://"$FRONTEND_BUCKET" \
              --index-document index.html \
              --error-document index.html \
              --region ${{ env.AWS_REGION }}

            FRONTEND_URL="http://${FRONTEND_BUCKET}.s3-website-${{ env.AWS_REGION }}.amazonaws.com"
            echo "âœ… Frontend deployed to: $FRONTEND_URL"
          else
            echo "âŒ Frontend bucket not found in stack outputs"
            exit 1
          fi


  # Post-deployment validation
  validate-deployment:
    name: Validate Deployment
    runs-on: ubuntu-latest
    needs: [deploy-dev, deploy-prod]
    if: always() && (needs.deploy-dev.result == 'success' || needs.deploy-prod.result == 'success')
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate deployment
        run: |
          echo "ðŸ” Validating deployment across all environments..."

          # Check if any deployment succeeded
          if [ "${{ needs.deploy-dev.result }}" = "success" ]; then
            echo "âœ… Development deployment validated"
          fi

          if [ "${{ needs.deploy-prod.result }}" = "success" ]; then
            echo "âœ… Production deployment validated"
          fi

          echo "ðŸŽ‰ All successful deployments validated!"

  # Cleanup failed deployments
  cleanup:
    name: Cleanup Failed Deployments
    runs-on: ubuntu-latest
    needs: [deploy-dev, deploy-prod]
    if: failure() && (needs.deploy-dev.result == 'failure' || needs.deploy-prod.result == 'failure')
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials via OIDC
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::${{ secrets.AWS_ACCOUNT_ID }}:role/personal-github-oidc-role
          aws-region: ${{ env.AWS_REGION }}

      - name: Cleanup failed deployment
        if: failure()
        run: |
          ENVIRONMENT="${{ github.event.inputs.environment || 'dev' }}"
          STACK_NAME="secureauditai-agent-${ENVIRONMENT}"
          echo "ðŸ§¹ Cleaning up failed deployment for stack: $STACK_NAME"

          # Check if stack exists and delete it
          if aws cloudformation describe-stacks --stack-name "$STACK_NAME" --region ${{ env.AWS_REGION }} &> /dev/null; then
            echo "Deleting failed stack..."
            aws cloudformation delete-stack \
              --stack-name "$STACK_NAME" \
              --region ${{ env.AWS_REGION }}

            aws cloudformation wait stack-delete-complete \
              --stack-name "$STACK_NAME" \
              --region ${{ env.AWS_REGION }} || echo "Stack deletion completed with warnings"
          fi

          echo "âœ… Cleanup completed"
